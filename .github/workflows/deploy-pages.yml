name: Build, Prerender and Deploy to GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build production assets
        run: npm run build

      - name: Export dist -> static
        run: npm run export

      - name: Prerender static HTML
        run: npm run prerender
        env:
          # Allow Puppeteer to download Chromium (default behavior) if needed
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'false'

      - name: Deploy to gh-pages branch (via peaceiris)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./prerendered
          publish_branch: gh-pages

# Note: using peaceiris/actions-gh-pages avoids deprecated internal dependencies and
# pushes the generated `prerendered/` folder to the `gh-pages` branch for Pages hosting.

  smoke-test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Wait for GitHub Pages to become available
        run: |
          set -e
          URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          echo "Checking $URL"
          STATUS=000
          for i in {1..12}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" ) || STATUS=000
            if [ "$STATUS" = "200" ]; then
              echo "Pages reachable"
              break
            fi
            echo "Attempt $i: status=$STATUS"
            sleep 10
          done
          if [ "$STATUS" != "200" ]; then
            echo "ERROR: Pages not reachable after retries"
            exit 1
          fi
      - name: Verify content on homepage
        run: |
          URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          echo "Fetching $URL"
          content=$(curl -fsS "$URL")
          echo "$content" | grep -q "RF ASSOCIATES" || (echo "Expected content not found" ; exit 1)
          echo "Smoke-test passed: content found"

